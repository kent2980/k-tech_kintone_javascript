# BOXディレクトリ概要

BOXディレクトリは、kintoneカスタマイズJavaScriptの機能別実装を格納するディレクトリです。各サブディレクトリは特定の業務機能に対応したモジュール化された実装となっています。

## ディレクトリ構造

```text
src/BOX/
└── PL_dashboard/          # 損益計算書（P&L）ダッシュボード機能
    ├── PL_dashboard.ts     # メインエントリーポイント
    ├── PL_dashboard.css    # スタイルシート
    ├── components/            # UIコンポーネント
    ├── services/             # ビジネスロジック・API呼び出し
    ├── utils/               # ユーティリティ関数
    ├── types/               # TypeScript型定義
    ├── constants/           # 定数定義
    ├── fields/             # kintoneフィールド型定義
    └── **tests**/          # テストファイル
```

## 各ディレクトリの役割と責務

### PLダッシュボード/

**目的**: 生産日報データから損益計算書（Profit & Loss）を生成・表示するダッシュボード機能

**主な機能**:

- 生産実績データの可視化
- 利益率計算とグラフ表示
- フィルタリング機能（年月別）
- データエクスポート（Excel、PDF）
- リアルタイムデータ更新

#### components/ - UIコンポーネント

**役割**: ユーザーインターフェース部品の実装

**含まれるコンポーネント**:

- `FilterContainer.ts`: フィルタリング用UI（年月選択など）
- `PLDashboardDomBuilder.ts`: メインダッシュボードのDOM構築
- `PLDashboardTableBuilder.ts`: データテーブルの構築・設定
- `TabContainer.ts`: タブ切り替え機能

**新機能追加方法**:

1. 新しいコンポーネントファイルを作成（例: `NewComponent.ts`）
2. `index.ts`にエクスポート文を追加
3. TypeScriptクラス形式で実装
4. DOM操作は `DomUtil`を使用し、統一した方式で実装

#### services/ - ビジネスロジック

**役割**: データ処理・API通信・ビジネスロジックの実装

**含まれるサービス**:

- `KintoneApiService.ts`: kintone REST APIとの通信
- `DataProcessor.ts`: データ変換・計算処理

**新機能追加方法**:

1. 新サービスクラスを作成（例: `NewService.ts`）
2. `index.ts`にエクスポート文を追加
3. 既存のサービスクラスを参考に実装
4. エラーハンドリングは統一した形式で実装

#### utils/ - ユーティリティ

**役割**: 汎用的な共通関数・ヘルパー関数の実装

**含まれるユーティリティ**:

- `CalculationUtil.ts`: 数値計算・利益率算出
- `DateUtil.ts`: 日付操作・フォーマット
- `DomUtil.ts`: DOM操作ヘルパー
- `Logger.ts`: ログ出力・デバッグ
- `PerformanceUtil.ts`: パフォーマンス測定

**新機能追加方法**:

1. 新ユーティリティファイルを作成
2. 静的メソッドまたは関数として実装
3. `index.ts`にエクスポート文を追加
4. 単体テストを `**tests**/`に作成

#### types/ - 型定義

**役割**: TypeScript型定義の集約管理

**主な型定義**:

- `ProductHistoryData`: 生産実績データ型
- `TotalsByDate`: 日別集計データ型
- `FilterConfig`: フィルター設定型
- `ApiResponse`: API レスポンス型

**新機能追加方法**:

1. `index.ts`に新しい型定義を追加
2. インターフェースまたは型エイリアスで定義
3. JSDoc コメントで詳細な説明を記載

#### constants/ - 定数定義

**役割**: アプリケーション全体で使用する定数の管理

**主な定数**:

- `APP_IDS`: 各kintoneアプリのID
- `TABLE_COLUMNS`: テーブルカラム定義
- `CSS_CLASSES`: CSSクラス名
- `API_LIMITS`: API制限値

**新機能追加方法**:

1. `index.ts`に新しい定数オブジェクトを追加
2. `as const`でリテラル型として定義
3. カテゴリごとに分けて整理

#### fields/ - kintoneフィールド型定義

**役割**: kintoneアプリのフィールド型定義

**含まれる定義**:

- `daily_fields.d.ts`: 生産日報フィールド
- `line_daily_fields.d.ts`: ライン日別フィールド
- `month_fields.d.ts`: 月次フィールド
- `model_master_fields.d.ts`: 機種マスタフィールド

**新機能追加方法**:

1. 新しいkintoneアプリに対応するフィールド定義ファイルを作成
2. kintone CLI等で型定義を生成
3. メインファイルで `/// <reference path="..." />`で参照

#### **tests**/ - テストファイル

**役割**: 単体テスト・統合テストの実装

**テスト方針**:

- Jestを使用した単体テスト
- 各コンポーネント・サービス・ユーティリティのテスト
- モック・スタブを活用したAPIテスト

**新機能追加方法**:

1. 対応するテストファイルを作成（例: `NewComponent.test.ts`）
2. Jest の設定に従ってテストを実装
3. カバレッジ目標を80%以上に設定

## アーキテクチャパターン

このプロジェクトは以下のアーキテクチャパターンを採用しています:

### レイヤードアーキテクチャ

- **Presentation Layer** (components/): UI表示・ユーザー操作
- **Business Layer** (services/): ビジネスロジック・データ処理
- **Utility Layer** (utils/): 共通処理・ヘルパー

### 責務分離の原則

- 各クラス・関数は単一の責務を持つ
- 依存関係は上位層から下位層へ
- ユーティリティは依存なしの純粋関数

## 開発ガイドライン

### コーディング規約

1. **命名規則**:

   - クラス名: PascalCase
   - メソッド・変数名: camelCase
   - 定数: UPPER_SNAKE_CASE
   - ファイル名: PascalCase
2. **ファイル構成**:

   - 1ファイル1クラスを基本とする
   - `index.ts`でエクスポートを集約
   - 循環依存を避ける
3. **TypeScript活用**:

   - 型安全性を重視
   - `any`型の使用を避ける
   - インターフェースでコントラクトを定義

### 新機能開発フロー

1. **設計フェーズ**

   ```text
   要件定義 → 型定義作成 → インターフェース設計
   ```

2. **実装フェーズ**

   ```text
   ユーティリティ → サービス → コンポーネント → メイン処理
   ```

3. **テストフェーズ**

   ```text
   単体テスト → 統合テスト → E2Eテスト
   ```

### ファイル追加時のチェックリスト

- [ ] 適切なディレクトリに配置
- [ ] `index.ts`にエクスポート追加
- [ ] 型定義の追加（必要に応じて）
- [ ] JSDocコメントの記載
- [ ] 単体テストの作成
- [ ] ESLintエラーの解消

## 関連技術スタック

- **フレームワーク**: TypeScript, Vite
- **テスト**: Jest
- **kintone**: REST API, JavaScript/CSS カスタマイズ
- **外部ライブラリ**: DataTables, Chart.js等

## トラブルシューティング

### よくある問題

1. **型エラー**: `globals.d.ts`と `kintone.d.ts`の参照を確認
2. **ビルドエラー**: 循環依存がないかチェック
3. **実行時エラー**: kintoneアプリIDと実際のアプリが一致するか確認

### デバッグ方法

1. `Logger.ts`を使用したログ出力
2. ブラウザ開発者ツールでのデバッグ
3. `PerformanceUtil.ts`でのパフォーマンス測定

---

## 今後の拡張予定

このディレクトリ構造は今後以下のような機能追加を予定しています:

- **新規ダッシュボード機能**: 売上分析、品質管理等
- **共通UIライブラリ**: 再利用可能なコンポーネント
- **データ可視化強化**: より高度なグラフ・チャート機能

新機能を追加する際は、このドキュメントの構造とガイドラインに従って実装してください。
